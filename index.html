<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×©×¨×•×ª×™ ×¨×›×‘ ×¤× ×¡×™× ×•××¨××•×ª - ×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            font-family: 'Heebo', sans-serif;
        }
        
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #c31432 0%, #f15a24 35%, #ff6b35 65%, #ff8c42 100%);
            animation: gradientShift 8s ease infinite;
            background-size: 200% 200%;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b35 0%, #f15a24 100%);
            box-shadow: 0 10px 30px rgba(241, 90, 36, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(241, 90, 36, 0.5);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .input-field {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        
        .input-field:focus {
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
            transform: translateY(-1px);
        }
        
        .pulse-icon {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        .progress-bar {
            height: 4px;
            background: linear-gradient(to right, #ff6b35, #f15a24);
            transition: width 0.3s ease;
        }
        
        .checkmark-icon {
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: drawCheck 0.6s ease-out forwards;
        }
        
        @keyframes drawCheck {
            to {
                stroke-dashoffset: 0;
            }
        }
        
        .feature-card {
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .image-preview-item {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .image-preview-item:hover {
            transform: scale(1.05);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b35;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 2rem;
        }
        
        .carousel-inner {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        
        .carousel-item {
            min-width: 100%;
            flex-shrink: 0;
        }
        
        .carousel-item img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
        }
        
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 107, 53, 0.8);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .carousel-button:hover {
            background: rgba(255, 107, 53, 1);
            transform: translateY(-50%) scale(1.1);
        }
        
        .carousel-button-prev {
            left: 20px;
        }
        
        .carousel-button-next {
            right: 20px;
        }
        
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            padding: 0 20px;
        }
        
        .carousel-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #d1d5db;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .carousel-dot.active {
            background: #ff6b35;
            width: 32px;
            border-radius: 6px;
        }
        
        .carousel-dot:hover {
            background: #ff6b35;
        }
        
        
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23ff6b35'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 1rem center;
            background-size: 1.5em 1.5em;
            padding-left: 3rem;
        }
        
        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .chat-bubble-ofer {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .chat-bubble-customer {
            background: #f3f4f6;
            color: #1f2937;
        }
        
        .chat-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #ff6b35;
            border-radius: 10px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #f15a24;
        }

        .firebase-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="glass-card rounded-3xl p-8 max-w-2xl w-full text-center">
                <div class="spinner mx-auto mb-4"></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">×˜×•×¢×Ÿ...</h2>
                <p class="text-gray-600">××ª×—×‘×¨ ×œ×©×¨×ª</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7De2P8cCUx9l3X4sllsNFOlHYETFtiUQ",
            authDomain: "car-parts-ofer-f2ca7.firebaseapp.com",
            projectId: "car-parts-ofer-f2ca7",
            storageBucket: "car-parts-ofer-f2ca7.firebasestorage.app",
            messagingSenderId: "403974770112",
            appId: "1:403974770112:web:025ab6f003622063384c25",
            measurementId: "G-XVGTV0LH9P"
        };

        // Check if Firebase is configured
        const isFirebaseConfigured = !firebaseConfig.apiKey.includes('YOUR_');

        if (!isFirebaseConfigured) {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass-card rounded-3xl p-8 max-w-3xl w-full">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">âš ï¸</div>
                            <h1 class="text-3xl font-bold text-red-600 mb-2">× ×“×¨×©×ª ×”×’×“×¨×ª Firebase</h1>
                            <p class="text-gray-700 text-lg">×›×“×™ ×©×”××ª×¨ ×™×¢×‘×•×“, ×¦×¨×™×š ×œ×”×’×“×™×¨ ××ª Firebase</p>
                        </div>

                        <div class="bg-blue-50 border-2 border-blue-300 rounded-2xl p-6 text-right">
                            <h2 class="text-2xl font-bold text-blue-900 mb-4">ğŸ“‹ ×”×•×¨××•×ª ×”×’×“×¨×”:</h2>
                            <ol class="space-y-3 text-gray-800">
                                <li class="font-semibold">1ï¸âƒ£ ×›× ×¡ ×œ: <a href="https://console.firebase.google.com" target="_blank" class="text-blue-600 underline">Firebase Console</a></li>
                                <li>2ï¸âƒ£ ×œ×—×¥ ×¢×œ "Add project" (××• "×”×•×¡×£ ×¤×¨×•×™×§×˜")</li>
                                <li>3ï¸âƒ£ ×ª×Ÿ ×©× ×œ×¤×¨×•×™×§×˜: <code class="bg-white px-2 py-1 rounded">car-parts-ofer</code></li>
                                <li>4ï¸âƒ£ ××¤×©×¨/×›×‘×” Google Analytics (×œ× ×—×©×•×‘)</li>
                                <li>5ï¸âƒ£ ×œ×—×¥ ×¢×œ "Create project"</li>
                                <li>6ï¸âƒ£ ××—×¨×™ ×©×”×¤×¨×•×™×§×˜ × ×•×¦×¨, ×œ×—×¥ ×¢×œ ×”××™×™×§×•×Ÿ <code>&lt;/&gt;</code> (Web)</li>
                                <li>7ï¸âƒ£ ×ª×Ÿ ×©× ×œ××¤×œ×™×§×¦×™×”: <code class="bg-white px-2 py-1 rounded">Car Parts Site</code></li>
                                <li>8ï¸âƒ£ ×ª×¢×ª×™×§ ××ª ×”-<strong>firebaseConfig</strong> ×©×™×•×¤×™×¢</li>
                                <li>9ï¸âƒ£ ×‘×¦×“ ×©×××œ, ×œ×—×¥ ×¢×œ <strong>Firestore Database</strong></li>
                                <li>ğŸ”Ÿ ×œ×—×¥ "Create database" â†’ ×‘×—×¨ ××™×§×•× <strong>europe-west</strong> â†’ <strong>Start in production mode</strong></li>
                                <li>1ï¸âƒ£1ï¸âƒ£ ×œ×—×¥ ×¢×œ <strong>Rules</strong> ×œ××¢×œ×” ×•×©× ×” ×œ:</li>
                            </ol>
                            <pre class="bg-gray-800 text-white p-4 rounded-lg mt-4 text-left text-sm overflow-x-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /requests/{document=**} {
      allow read, write: if true;
    }
  }
}</code></pre>
                            <p class="mt-4 font-bold text-red-600">1ï¸âƒ£2ï¸âƒ£ ×œ×—×¥ "Publish" ×›×“×™ ×œ×©××•×¨</p>
                            <p class="mt-4 font-bold text-green-700">1ï¸âƒ£3ï¸âƒ£ ×¢×›×©×™×• ×ª×—×œ×™×£ ××ª ×”-firebaseConfig ×‘×§×•×“ ×‘×©×•×¨×” 233</p>
                        </div>

                        <div class="mt-6 bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 text-center">
                            <p class="font-bold text-yellow-800">ğŸ’¡ ×¦×¨×™×š ×¢×–×¨×”? ×ª×’×™×“ ×œ×™ ×•×× ×™ ××¡×‘×™×¨ ×©×œ×‘ ××—×¨ ×©×œ×‘!</p>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Initialize Firebase
            let app, db;
            try {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('âœ… Firebase initialized successfully');
            } catch (error) {
                console.error('âŒ Firebase initialization error:', error);
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="glass-card rounded-3xl p-8 max-w-2xl w-full text-center">
                            <div class="text-6xl mb-4">âŒ</div>
                            <h2 class="text-2xl font-bold text-red-600 mb-2">×©×’×™××ª ×—×™×‘×•×¨</h2>
                            <p class="text-gray-700">×œ× ×”×¦×œ×—× ×• ×œ×”×ª×—×‘×¨ ×œ-Firebase</p>
                            <p class="text-sm text-gray-600 mt-2">${error.message}</p>
                            <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-xl">
                                × ×¡×” ×©×•×‘
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Admin credentials
            const ADMIN_USERNAME = 'ofer';
            const ADMIN_PASSWORD = 'panasim2024';
            
            // Check if we're on admin page
            const hasSecretLink = window.location.hash === '#admin-secret-ofer-2024';
            const isAuthenticated = sessionStorage.getItem('adminAuth') === 'true';
            
            // Global state
            let currentView = (hasSecretLink || isAuthenticated) ? 'admin' : 'customer';
            let requests = [];
            let selectedRequest = null;
            let formData = { 
                carPart: '', 
                carManufacturer: '', 
                carModel: '', 
                year: '', 
                description: '', 
                name: '', 
                phone: '', 
                email: '',
                urgency: '×¨×’×™×œ'
            };
            let images = [];
            let responseText = '';
            let customerReplyText = '';
            let showSuccess = false;
            let showStatusCheck = false;
            let statusPhone = '';
            let statusResult = null;
            let formProgress = 0;
            let isSubmitting = false;
            let isLoading = true;
            let requestsLoaded = false; // Add this flag

            // Load requests from Firebase
            async function loadRequests() {
                if (requestsLoaded) return; // Don't reload if already loaded
                try {
                    const snapshot = await db.collection('requests').orderBy('createdAt', 'desc').get();
                    requests = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    console.log('Requests loaded:', requests.length, 'rated:', requests.filter(r => r.rating).length);
                    requestsLoaded = true;
                    isLoading = false;
                    render();
                } catch (error) {
                    console.error('Error loading requests:', error);
                    isLoading = false;
                    render();
                }
            }

            // Listen to real-time updates (for admin)
            function listenToRequests() {
                db.collection('requests').orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        requests = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        // Update selected request if viewing one
                        if (selectedRequest) {
                            selectedRequest = requests.find(r => r.id === selectedRequest.id);
                        }
                        
                        render();
                    }, (error) => {
                        console.error('Error listening to requests:', error);
                    });
            }

            // Calculate form progress
            function calculateProgress() {
                const fields = ['carPart', 'carManufacturer', 'carModel', 'name', 'phone'];
                const filled = fields.filter(f => formData[f]).length;
                formProgress = (filled / fields.length) * 100;
            }

            // Initialize app
            async function initializeApp() {
                try {
                    if (currentView === 'admin') {
                        isLoading = false;
                        render();
                        listenToRequests();
                    } else {
                        isLoading = false;
                        render();
                        await loadRequests();
                    }
                } catch (error) {
                    console.error('Initialization error:', error);
                    isLoading = false;
                    render();
                }
            }

            initializeApp();

            // Render functions
            function render() {
                const app = document.getElementById('app');
                
                if (isLoading) {
                    return; // Keep loading screen
                }
                
                if (currentView === 'customer') {
                    app.innerHTML = renderCustomerView();
                } else {
                    app.innerHTML = renderAdminView();
                }
                attachEventListeners();
            }

            // [REST OF THE CODE CONTINUES WITH SAME RENDER FUNCTIONS...]
            // I'll add a note here that the render functions are identical to the previous version
            // but I'll include a complete working version

            function renderCustomerView() {
                // If viewing a request, show the chat
                if (selectedRequest) {
                    return renderSingleRequest();
                }

                calculateProgress();
                
                return `
                    <div class="min-h-screen p-4 pb-20">
                        <div class="max-w-2xl mx-auto">
                            ${formProgress > 0 && !showSuccess ? `
                            <div class="fixed top-0 left-0 right-0 z-50 bg-white shadow-md">
                                <div class="progress-bar" style="width: ${formProgress}%"></div>
                            </div>
                            ` : ''}

                            <div class="w-full mb-8">
                                <img src="header.png" alt="×©×¨×•×ª×™ ×¨×›×‘ ×¤× ×¡×™× ×•××¨××•×ª" class="w-full h-auto object-contain">
                            </div>

                            <div class="text-center text-white mb-8 py-12 fade-in">
                                <h1 class="text-5xl font-bold mb-3 leading-tight">×—×œ×§×™ ×—×™×œ×•×£ ××©×•××©×™×</h1>
                                <h2 class="text-4xl font-bold mb-6 leading-tight">×‘××™×›×•×ª ××¢×•×œ×” ğŸ†</h2>
                                <p class="text-xl text-white/95 mb-4 max-w-xl mx-auto leading-relaxed">
                                    ××ª××—×™× ×‘××™×ª×•×¨ ×•××¡×¤×§×” ×©×œ ×—×œ×§×™ ×¨×›×‘ ××©×•××©×™× ××›×œ ×”×¡×•×’×™×
                                </p>
                                <p class="text-lg text-white/90 font-medium">×¤× ×¡×™× â€¢ ××¨××•×ª â€¢ ×’×¨×™×œ×™× â€¢ ×“×œ×ª×•×ª â€¢ ×•×¢×•×“</p>
                                
                                <div class="flex flex-wrap justify-center gap-6 mt-8 text-sm font-medium">
                                    <div class="flex items-center gap-2 bg-white/20 backdrop-blur-sm px-5 py-3 rounded-full">
                                        <div class="w-6 h-6 bg-white text-orange-500 rounded-full flex items-center justify-center font-bold">âœ“</div>
                                        <span class="text-white font-semibold">××œ××™ ×¢× ×§</span>
                                    </div>
                                    <div class="flex items-center gap-2 bg-white/20 backdrop-blur-sm px-5 py-3 rounded-full">
                                        <div class="w-6 h-6 bg-white text-orange-500 rounded-full flex items-center justify-center font-bold">âœ“</div>
                                        <span class="text-white font-semibold">××—×™×¨×™× ×”×•×’× ×™×</span>
                                    </div>
                                    <div class="flex items-center gap-2 bg-white/20 backdrop-blur-sm px-5 py-3 rounded-full">
                                        <div class="w-6 h-6 bg-white text-orange-500 rounded-full flex items-center justify-center font-bold">âœ“</div>
                                        <span class="text-white font-semibold">×©×™×¨×•×ª ××”×™×¨</span>
                                    </div>
                                </div>

                                <div class="mt-8 space-y-3">
                                    <button
                                        onclick="toggleStatusCheck()"
                                        class="bg-white/20 backdrop-blur-sm text-white px-8 py-4 rounded-2xl hover:bg-white/30 transition-all font-bold border-2 border-white/40 inline-flex items-center gap-3 shadow-lg"
                                    >
                                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                        </svg>
                                        ×‘×“×•×§ ×¡×˜×˜×•×¡ ×‘×§×©×”
                                    </button>
                                    
                                    <div class="text-white/80 text-sm">
                                        <p>ğŸ“ ××©×” ×‘×§×¨ 31, ×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ</p>
                                        <a href="tel:0501234567" class="inline-block mt-2 hover:text-white transition">ğŸ“ 050-123-4567</a>
                                    </div>
                                </div>
                            </div>

                            ${showStatusCheck ? renderStatusCheck() : ''}
                            ${showSuccess ? renderSuccessMessage() : ''}
                            ${!showStatusCheck && !showSuccess ? renderForm() : ''}
                            ${!showStatusCheck ? renderTrustIndicators() : ''}
                            ${!showStatusCheck ? renderGallery() : ''}
                            ${!showStatusCheck ? renderReviews() : ''}
                            ${renderFooter()}
                        </div>
                    </div>
                `;
            }

            function renderSuccessMessage() {
                return `
                    <div class="glass-card rounded-3xl p-8 mb-8 shadow-2xl fade-in">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4">
                                <svg class="w-12 h-12 text-green-600 checkmark-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-green-800 mb-2">×”×‘×§×©×” × ×©×œ×—×” ×‘×”×¦×œ×—×”! ğŸ‰</h3>
                            <p class="text-green-700 text-lg">× ×—×–×•×¨ ××œ×™×š ×ª×•×š 24 ×©×¢×•×ª</p>
                        </div>
                    </div>
                `;
            }

            function renderForm() {
                return `
                    <div class="glass-card rounded-3xl shadow-2xl p-8 mb-8 fade-in">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl p-4 shadow-lg">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-3xl font-bold text-gray-800">×©×œ×— ×‘×§×©×”</h3>
                                <p class="text-gray-600 text-sm mt-1">××œ× ××ª ×”×¤×¨×˜×™× ×•× ×—×–×•×¨ ××œ×™×š ×‘×”×§×“×</p>
                            </div>
                        </div>

                        <form id="customerForm" class="space-y-6">
                            ${renderFormFields()}
                            
                            <button
                                type="submit"
                                class="btn-primary w-full text-white py-6 rounded-2xl font-bold text-2xl flex items-center justify-center gap-4"
                                ${isSubmitting ? 'disabled' : ''}
                            >
                                ${isSubmitting ? '<div class="spinner"></div><span>×©×•×œ×—...</span>' : '<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg><span>×©×œ×— ×‘×§×©×”</span>'}
                            </button>
                            
                            <p class="text-center text-gray-500 text-sm mt-4">ğŸ”’ ×”××™×“×¢ ×©×œ×š ×××•×‘×˜×— ×•× ×©××¨ ×‘×¢× ×Ÿ</p>
                        </form>
                    </div>
                `;
            }

            function renderFormFields() {
                return `
                    <select id="carPart" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none bg-white text-lg font-medium" required>
                        <option value="">×‘×—×¨ ×¡×•×’ ×—×œ×§ *</option>
                        <option value="×¤× ×¡ ×§×“××™">×¤× ×¡ ×§×“××™</option>
                        <option value="×¤× ×¡ ××—×•×¨×™">×¤× ×¡ ××—×•×¨×™</option>
                        <option value="××¨××” ×¦×“">××¨××” ×¦×“</option>
                        <option value="×’×¨×™×œ ×§×“××™">×’×¨×™×œ ×§×“××™</option>
                        <option value="×¤×’×•×© ×§×“××™">×¤×’×•×© ×§×“××™</option>
                        <option value="×¤×’×•×© ××—×•×¨×™">×¤×’×•×© ××—×•×¨×™</option>
                        <option value="×“×œ×ª">×“×œ×ª</option>
                        <option value="××›×¡×” ×× ×•×¢">××›×¡×” ×× ×•×¢</option>
                        <option value="××›×¡×” ×ª× ××˜×¢×Ÿ">××›×¡×” ×ª× ××˜×¢×Ÿ</option>
                        <option value="×¤× ×“×¨">×¤× ×“×¨</option>
                        <option value="××—×¨">××—×¨</option>
                    </select>
                    
                    <input type="text" id="carManufacturer" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none text-lg" placeholder="×™×¦×¨×Ÿ ×”×¨×›×‘ *" required />
                    <input type="text" id="carModel" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none text-lg" placeholder="×“×’× ×”×¨×›×‘ *" required />
                    <input type="text" id="year" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none text-lg" placeholder="×©× ×ª ×™×™×¦×•×¨" />
                    <textarea id="description" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none text-lg resize-none" rows="4" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×..."></textarea>
                    
                    <select id="urgency" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none bg-white text-lg font-medium" required>
                        <option value="×¨×’×™×œ">×¨×’×™×œ - ×ª×•×š ××¡×¤×¨ ×™××™×</option>
                        <option value="×“×—×•×£">×“×—×•×£ - ×ª×•×š 24 ×©×¢×•×ª</option>
                        <option value="×“×—×•×£ ×××•×“">×“×—×•×£ ×××•×“ - ×”×™×•×!</option>
                    </select>
                    
                    <input type="text" id="name" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none text-lg" placeholder="×©× ××œ× *" required />
                    <input type="tel" id="phone" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none text-lg" placeholder="×˜×œ×¤×•×Ÿ *" required />
                    <input type="email" id="email" class="input-field w-full p-5 border-2 rounded-2xl text-right focus:outline-none text-lg" placeholder="××™××™×™×œ (××•×¤×¦×™×•× ×œ×™)" />
                `;
            }

            function renderGallery() {
                const galleryImages = [
                    { src: 'store-front.png', alt: '×—× ×•×ª ×”×¨××©×™×ª' },
                    { src: 'mirrors.png', alt: '××¨××•×ª ××©×•××©×•×ª' },
                    { src: 'parts-display.png', alt: '×¤× ×¡×™× ×•××¨××•×ª' },
                    { src: 'car-parts.png', alt: '×—×œ×§×™ ×¨×›×‘' },
                    { src: 'headlights.png', alt: '×¤× ×¡×™× LED' }
                ];

                return `
                    <div class="mt-16 mb-8 fade-in">
                        <div class="text-center mb-12">
                            <h2 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“¸ ×’×œ×¨×™×™×ª ×”××•×¦×¨×™× ×©×œ× ×•</h2>
                            <p class="text-gray-600 text-lg">×›×œ ××” ×©×™×© ×œ× ×• ×‘×—× ×•×ª</p>
                        </div>

                        <div class="glass-card rounded-3xl overflow-hidden shadow-2xl">
                            <div class="carousel-container">
                                <div class="carousel-inner" id="carouselInner">
                                    ${galleryImages.map((img, idx) => `
                                        <div class="carousel-item" data-index="${idx}">
                                            <img src="${img.src}" alt="${img.alt}" class="w-full">
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <button class="carousel-button carousel-button-prev" onclick="carouselPrev()">â®</button>
                                <button class="carousel-button carousel-button-next" onclick="carouselNext()">â¯</button>
                            </div>
                            
                            <div class="carousel-dots">
                                ${galleryImages.map((_, idx) => `
                                    <div class="carousel-dot ${idx === 0 ? 'active' : ''}" onclick="carouselGoTo(${idx})" data-index="${idx}"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderReviews() {
                // Get all rated requests and sort by rating (highest first)
                const ratedRequests = requests
                    .filter(r => r.rating && r.rating > 0)
                    .sort((a, b) => b.rating - a.rating);
                
                if (ratedRequests.length === 0) {
                    return '';
                }

                const getRatingStars = (rating) => {
                    let stars = '';
                    for (let i = 0; i < 5; i++) {
                        stars += i < rating ? 'â­' : 'â˜†';
                    }
                    return stars;
                };

                return `
                    <div class="mt-16 mb-8 fade-in">
                        <div class="text-center mb-12">
                            <h2 class="text-4xl font-bold text-gray-800 mb-2">â­ ×—×•×•×ª ×“×¢×ª ×©×œ ×œ×§×•×—×•×ª</h2>
                            <p class="text-gray-600 text-lg">××” ×”×œ×§×•×—×•×ª ×©×œ× ×• ×—×•×©×‘×™× ×¢×œ×™× ×•</p>
                            <div class="mt-4">
                                <p class="text-2xl font-bold text-orange-500">
                                    ${(ratedRequests.reduce((sum, r) => sum + r.rating, 0) / ratedRequests.length).toFixed(1)} / 5
                                </p>
                                <p class="text-sm text-gray-600">${ratedRequests.length} ×“×™×¨×•×’×™×</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            ${ratedRequests.slice(0, 3).map((req, idx) => `
                                <div class="glass-card rounded-3xl p-8 text-right hover:shadow-2xl transition-all transform hover:scale-105 ${idx === 0 ? 'md:col-span-1 md:row-span-1 border-2 border-orange-300 shadow-lg' : ''}">
                                    <div class="flex justify-end gap-1 mb-4 text-2xl">
                                        ${getRatingStars(req.rating)}
                                    </div>
                                    
                                    <p class="text-gray-700 mb-6 italic text-base leading-relaxed">"${req.review || '×©×™×¨×•×ª ××¢×•×œ×” ×•×××© ××•××œ×¥!'}"</p>
                                    
                                    <div class="border-t border-gray-200 pt-4 mt-4">
                                        <p class="font-bold text-gray-900 text-lg">${req.name}</p>
                                        <p class="text-sm text-gray-600">ğŸ“ ${req.phone}</p>
                                        <p class="text-xs text-gray-500 mt-2">ğŸ”§ ${req.carPart}</p>
                                        ${req.carManufacturer ? `<p class="text-xs text-gray-500">ğŸš— ${req.carManufacturer} ${req.carModel}</p>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            function renderTrustIndicators() {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="glass-card rounded-2xl p-6 text-center feature-card">
                            <div class="text-4xl mb-3">âš¡</div>
                            <h4 class="font-bold text-gray-800 mb-1">××¢× ×” ×ª×•×š 24 ×©×¢×•×ª</h4>
                            <p class="text-gray-600 text-sm">× ×—×–×•×¨ ××œ×™×š ×‘××”×™×¨×•×ª</p>
                        </div>
                        <div class="glass-card rounded-2xl p-6 text-center feature-card">
                            <div class="text-4xl mb-3">âœ“</div>
                            <h4 class="font-bold text-gray-800 mb-1">×©×™×¨×•×ª ××§×¦×•×¢×™</h4>
                            <p class="text-gray-600 text-sm">×¦×•×•×ª ×× ×•×¡×” ×•××§×¦×•×¢×™</p>
                        </div>
                        <div class="glass-card rounded-2xl p-6 text-center feature-card">
                            <div class="text-4xl mb-3">ğŸ†</div>
                            <h4 class="font-bold text-gray-800 mb-1">××™×›×•×ª ××•×‘×˜×—×ª</h4>
                            <p class="text-gray-600 text-sm">×—×œ×§×™× ×‘×‘×“×™×§×” ×§×¤×“× ×™×ª</p>
                        </div>
                    </div>
                `;
            }

            function renderFooter() {
                return `
                    <div class="text-center text-white text-sm mt-12 pb-8">
                        <p class="font-bold text-lg mb-2">×©×¨×•×ª×™ ×¨×›×‘ ×¤× ×¡×™× ×•××¨××•×ª</p>
                        <p class="mb-1">×¨×—×•×‘ ××©×” ×‘×§×¨ 31, ×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ</p>
                        <a href="tel:0501234567" class="hover:underline">ğŸ“ 050-123-4567</a>
                        <p class="mt-4 text-white/70 text-xs">Â© 2024 ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª</p>
                    </div>
                `;
            }

            function renderStatusCheck() {
                return `<div class="glass-card rounded-3xl p-8 mb-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">×‘×“×•×§ ×¡×˜×˜×•×¡ ×‘×§×©×”</h2>
                        <button onclick="toggleStatusCheck()" class="text-gray-500 hover:text-gray-700 text-3xl">âœ•</button>
                    </div>
                    
                    <div class="space-y-4">
                        <input 
                            type="text" 
                            id="statusPhone" 
                            class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-orange-500 focus:outline-none transition text-right" 
                            placeholder="×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ××• ×©×..." 
                            value="${statusPhone}"
                        />
                        <button onclick="checkStatus()" class="btn-primary w-full py-3 rounded-xl text-white font-bold">ğŸ” ×—×¤×© ×‘×§×©×”</button>
                    </div>
                    
                    ${statusResult ? `
                        <div class="mt-6 p-6 bg-green-50 border-2 border-green-300 rounded-xl">
                            <h3 class="text-xl font-bold text-green-800 mb-4">âœ“ × ××¦××” ×‘×§×©×”!</h3>
                            <div class="space-y-3 text-right">
                                <p><span class="font-bold">ğŸ‘¤ ×©×:</span> ${statusResult.name || '×œ× ××•×’×“×¨'}</p>
                                <p><span class="font-bold">ğŸ“ ×˜×œ×¤×•×Ÿ:</span> ${statusResult.phone || '×œ× ××•×’×“×¨'}</p>
                                <p><span class="font-bold">ğŸ”§ ×—×œ×§:</span> ${statusResult.carPart || '×œ× ××•×’×“×¨'}</p>
                                <p><span class="font-bold">ğŸš— ×¨×›×‘:</span> ${statusResult.carManufacturer || ''} ${statusResult.carModel || '×œ× ××•×’×“×¨'}</p>
                                <p><span class="font-bold">ğŸ“… ×ª××¨×™×š:</span> ${new Date(statusResult.createdAt).toLocaleString('he-IL')}</p>
                                <p>
                                    <span class="font-bold">×¡×˜×˜×•×¡:</span> 
                                    <span class="inline-block px-3 py-1 rounded-full font-bold ${statusResult.status === 'answered' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                                        ${statusResult.status === 'answered' ? 'âœ“ × ×¢× ×ª×”' : 'â³ ×××ª×™× ×”'}
                                    </span>
                                </p>
                            </div>
                            
                            <button 
                                onclick="viewRequest('${statusResult.id}')" 
                                class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2"
                            >
                                ğŸ’¬ ×¤×ª×— ×¦'××˜ ×¢× ×¢×•×¤×¨
                            </button>
                            
                            <button 
                                onclick="deleteRequest('${statusResult.id}')" 
                                class="w-full mt-2 bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2"
                            >
                                ğŸ—‘ï¸ ××—×§ ×‘×§×©×”
                            </button>
                        </div>
                    ` : ''}
                </div>`;
            }

            function renderAdminView() {
                if (selectedRequest) {
                    return renderSingleRequest();
                }
                
                return `
                    <div class="min-h-screen p-4 bg-gray-50">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6 fade-in">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h1 class="text-4xl font-bold text-blue-900 mb-2">×¤×× ×œ × ×™×”×•×œ</h1>
                                        <p class="text-gray-600 text-lg">×©×œ×•× ×¢×•×¤×¨ ×¦×•×¨×™××œ ğŸ‘‹</p>
                                        <p class="text-sm text-green-600 font-semibold mt-2 flex items-center gap-2">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                            </svg>
                                            ××—×•×‘×¨ ×œ-Firebase âœ“
                                        </p>
                                    </div>
                                    <div class="text-left space-y-2">
                                        <div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg font-bold">
                                            â³ ×××ª×™× ×•×ª: ${requests.filter(r => r.status === 'pending').length}
                                        </div>
                                        <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-bold">
                                            âœ“ × ×¢× ×•: ${requests.filter(r => r.status === 'answered').length}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-3xl font-bold text-gray-800">×‘×§×©×•×ª ×œ×§×•×—×•×ª</h2>
                                    <span class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full font-bold">
                                        ×¡×”"×›: ${requests.length}
                                    </span>
                                </div>
                                
                                ${requests.length === 0 ? `
                                    <div class="text-center py-20 text-gray-400">
                                        <svg class="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                        </svg>
                                        <p class="text-2xl font-semibold mb-2">××™×Ÿ ×‘×§×©×•×ª ×›×¨×’×¢</p>
                                        <p class="text-lg">×‘×§×©×•×ª ×—×“×©×•×ª ×™×•×¤×™×¢×• ×›××Ÿ</p>
                                    </div>
                                ` : `
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm text-right">
                                            <thead class="bg-blue-900 text-white sticky top-0">
                                                <tr>
                                                    <th class="px-4 py-3 font-bold">×©×</th>
                                                    <th class="px-4 py-3 font-bold">ğŸ“ ×˜×œ×¤×•×Ÿ</th>
                                                    <th class="px-4 py-3 font-bold">ğŸ”§ ×—×œ×§</th>
                                                    <th class="px-4 py-3 font-bold">ğŸš— ×¨×›×‘</th>
                                                    <th class="px-4 py-3 font-bold">×©× ×”</th>
                                                    <th class="px-4 py-3 font-bold">×¡×˜×˜×•×¡</th>
                                                    <th class="px-4 py-3 font-bold">â­ ×“×™×¨×•×’</th>
                                                    <th class="px-4 py-3 font-bold">ğŸ“… ×ª××¨×™×š</th>
                                                    <th class="px-4 py-3 font-bold">×¤×¢×•×œ×”</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${requests.map((req, idx) => {
                                                    const hasNewMessages = req.conversation && req.conversation.some(msg => msg.sender === 'customer' && !msg.read);
                                                    return `
                                                    <tr class="border-b hover:bg-blue-50 cursor-pointer transition-all ${hasNewMessages ? 'bg-blue-100' : (idx % 2 === 0 ? 'bg-white' : 'bg-gray-50')}">
                                                        <td class="px-4 py-3 font-bold text-gray-800">${req.name}</td>
                                                        <td class="px-4 py-3 text-gray-700">${req.phone}</td>
                                                        <td class="px-4 py-3 text-orange-600 font-semibold">${req.carPart}</td>
                                                        <td class="px-4 py-3 text-gray-700">${req.carManufacturer} ${req.carModel}</td>
                                                        <td class="px-4 py-3 text-gray-700">${req.year || '-'}</td>
                                                        <td class="px-4 py-3">
                                                            <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${
                                                                req.status === 'answered' 
                                                                    ? 'bg-green-200 text-green-800' 
                                                                    : 'bg-yellow-200 text-yellow-800'
                                                            }">
                                                                ${req.status === 'answered' ? 'âœ“ × ×¢× ×ª×”' : 'â³ ×××ª×™× ×”'}
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-3">
                                                            ${req.rating ? `<span class="font-bold text-orange-500">${'â­'.repeat(req.rating)}</span>` : '<span class="text-gray-400">-</span>'}
                                                        </td>
                                                        <td class="px-4 py-3 text-gray-600 text-xs">${new Date(req.createdAt).toLocaleDateString('he-IL')}</td>
                                                        <td class="px-4 py-3">
                                                            <button onclick="viewRequest('${req.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg font-bold transition">
                                                                ×¦×¤×”
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderSingleRequest() {
                const conversation = selectedRequest.conversation || [];
                const isAdmin = currentView === 'admin';
                
                return `<div class="min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 flex flex-col">
                    <!-- Header -->
                    <div class="bg-white border-b-2 border-gray-200 p-4 shadow-md sticky top-0 z-50">
                        <div class="max-w-4xl mx-auto flex justify-between items-center">
                            <button onclick="backToList()" class="text-blue-600 font-bold text-lg hover:text-blue-700">â† ×—×–×¨×”</button>
                            <div class="text-center">
                                <h2 class="text-2xl font-bold text-gray-800">${selectedRequest.name}</h2>
                                <p class="text-sm text-gray-600">ğŸ“ ${selectedRequest.phone}</p>
                            </div>
                            <button onclick="deleteRequest('${selectedRequest.id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-bold transition">ğŸ—‘ï¸ ××—×•×§</button>
                        </div>
                    </div>

                    <!-- Info Bar -->
                    <div class="bg-white border-b border-gray-200 p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="grid grid-cols-4 gap-4 text-right text-sm">
                                <div><span class="font-bold text-gray-700">ğŸ”§ ×—×œ×§:</span> ${selectedRequest.carPart}</div>
                                <div><span class="font-bold text-gray-700">ğŸš— ×¨×›×‘:</span> ${selectedRequest.carManufacturer} ${selectedRequest.carModel}</div>
                                <div><span class="font-bold text-gray-700">ğŸ“… ×ª××¨×™×š:</span> ${new Date(selectedRequest.createdAt).toLocaleString('he-IL')}</div>
                                <div>
                                    <span class="font-bold text-gray-700">×¡×˜×˜×•×¡:</span>
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ml-2 ${selectedRequest.status === 'answered' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                                        ${selectedRequest.status === 'answered' ? 'âœ“ × ×¢× ×ª×”' : 'â³ ×××ª×™× ×”'}
                                    </span>
                                </div>
                            </div>
                            ${selectedRequest.description ? `<p class="mt-3 p-3 bg-gray-50 rounded-lg text-right text-sm"><span class="font-bold">ğŸ“ ×ª×™××•×¨:</span> ${selectedRequest.description}</p>` : ''}
                            ${selectedRequest.rating ? `
                                <div class="mt-3 p-3 bg-yellow-50 rounded-lg border-2 border-yellow-300">
                                    <p class="text-right font-bold text-gray-800">â­ ×“×™×¨×•×’ ×”×œ×§×•×—: ${selectedRequest.rating}/5</p>
                                    ${selectedRequest.review ? `<p class="text-right text-sm text-gray-700 mt-2">ğŸ’¬ "${selectedRequest.review}"</p>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Chat Container -->
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="max-w-4xl mx-auto space-y-4">
                            <!-- Initial Request -->
                            <div class="flex justify-end gap-3">
                                <div class="bg-blue-500 text-white rounded-3xl rounded-tr-none px-5 py-3 max-w-xs">
                                    <p class="text-sm">${selectedRequest.carPart} - ${selectedRequest.carManufacturer} ${selectedRequest.carModel}</p>
                                    <p class="text-xs text-blue-100 mt-1">${new Date(selectedRequest.createdAt).toLocaleTimeString('he-IL')}</p>
                                </div>
                            </div>

                            <!-- Conversation -->
                            ${conversation.map((msg, idx) => `
                                <div class="flex ${msg.sender === 'ofer' ? 'justify-start' : 'justify-end'} gap-3">
                                    <div class="rounded-3xl ${msg.sender === 'ofer' ? 'rounded-tl-none bg-gray-300 text-gray-900' : 'rounded-tr-none bg-blue-500 text-white'} px-5 py-3 max-w-xs">
                                        <p class="text-sm break-words">${msg.message}</p>
                                        <p class="text-xs ${msg.sender === 'ofer' ? 'text-gray-600' : 'text-blue-100'} mt-1">
                                            ${new Date(msg.timestamp).toLocaleTimeString('he-IL')}
                                            ${msg.sender === 'ofer' && msg.read ? ' âœ“âœ“' : (msg.sender === 'ofer' ? ' âœ“' : '')}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}

                            <!-- No Response Yet -->
                            ${!selectedRequest.response && conversation.length === 0 ? `
                                <div class="flex justify-center">
                                    <div class="text-center text-gray-500 py-8">
                                        <p class="text-lg">â³ ×‘×§×©×” ×××ª×™× ×” ×œ×ª×©×•×‘×”...</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-white border-t-2 border-gray-200 p-4 sticky bottom-0">
                        <div class="max-w-4xl mx-auto">
                            ${!isAdmin && selectedRequest.status === 'answered' && !selectedRequest.rating ? `
                                <div class="mb-4 p-4 bg-blue-50 rounded-2xl border-2 border-blue-200">
                                    <p class="text-sm font-bold text-gray-800 mb-3">â­ ×”×× ××ª×” ××¨×•×¦×” ××”×©×™×¨×•×ª?</p>
                                    <div class="flex justify-center gap-2 mb-3">
                                        <button onclick="submitRating(1)" class="text-3xl hover:scale-125 transition">ğŸ˜</button>
                                        <button onclick="submitRating(2)" class="text-3xl hover:scale-125 transition">ğŸ˜•</button>
                                        <button onclick="submitRating(3)" class="text-3xl hover:scale-125 transition">ğŸ˜</button>
                                        <button onclick="submitRating(4)" class="text-3xl hover:scale-125 transition">ğŸ˜Š</button>
                                        <button onclick="submitRating(5)" class="text-3xl hover:scale-125 transition">ğŸ˜</button>
                                    </div>
                                    <textarea 
                                        id="reviewText" 
                                        class="w-full p-2 border-2 border-gray-300 rounded-lg text-sm text-right" 
                                        rows="2"
                                        placeholder="×›×ª×•×‘ ×—×•×•×ª ×“×¢×ª (×œ× ×—×•×‘×”)..."
                                    ></textarea>
                                </div>
                            ` : ''}

                            ${selectedRequest.rating ? `
                                <div class="mb-4 p-4 bg-green-50 rounded-2xl border-2 border-green-200">
                                    <p class="text-sm font-bold text-gray-800">âœ“ ×ª×•×“×” ×¢×œ ×”×“×™×¨×•×’ ×©×œ×š!</p>
                                    <p class="text-lg mt-2">${'â­'.repeat(selectedRequest.rating)}</p>
                                    ${selectedRequest.review ? `<p class="text-sm text-gray-700 mt-2">ğŸ’¬ "${selectedRequest.review}"</p>` : ''}
                                </div>
                            ` : ''}

                            <div class="flex gap-3">
                                <textarea 
                                    id="responseText" 
                                    class="flex-1 p-4 border-2 border-gray-300 rounded-2xl focus:border-blue-500 focus:outline-none transition resize-none"
                                    rows="2"
                                    placeholder="${isAdmin ? 'ğŸ’¬ ×›×ª×•×‘ ×ª×©×•×‘×”...' : 'ğŸ’¬ ×›×ª×•×‘ ×”×•×“×¢×”...'}"
                                ></textarea>
                                <button 
                                    onclick="sendResponse()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-2xl font-bold transition flex items-center gap-2 h-fit"
                                >
                                    ğŸ“¤ ×©×œ×—
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 text-center">
                                ${isAdmin ? 'ğŸ“ ××ª×” ×¢×•×¤×¨ - ×”×•×“×¢×•×ª×™×š ×‘×¢××•×' : 'ğŸ“ ××ª×” ×”×œ×§×•×— - ×”×•×“×¢×•×ª×™×š ×‘×›×—×•×œ'}
                            </p>
                        </div>
                    </div>
                </div>`;
            }

            // Event handlers
            function attachEventListeners() {
                const form = document.getElementById('customerForm');
                if (form) {
                    form.addEventListener('submit', handleSubmit);
                }

                ['carPart', 'carManufacturer', 'carModel', 'year', 'description', 'name', 'phone', 'email', 'urgency'].forEach(field => {
                    const input = document.getElementById(field);
                    if (input) {
                        input.addEventListener('input', (e) => {
                            formData[field] = e.target.value;
                            calculateProgress();
                            // Update progress bar without full re-render
                            const progressBar = document.querySelector('.progress-bar');
                            if (progressBar) {
                                progressBar.style.width = formProgress + '%';
                            }
                        });
                    }
                });

                // Add listener for status phone input
                const statusPhoneInput = document.getElementById('statusPhone');
                if (statusPhoneInput) {
                    statusPhoneInput.addEventListener('input', (e) => {
                        statusPhone = e.target.value;
                    });
                    statusPhoneInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            checkStatus();
                        }
                    });
                }
            }

            async function handleSubmit(e) {
                e.preventDefault();
                
                if (!formData.carPart || !formData.name || !formData.phone) {
                    alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”');
                    return;
                }

                isSubmitting = true;
                render();

                try {
                    const newRequest = {
                        ...formData,
                        images: [],
                        createdAt: new Date().toISOString(),
                        status: 'pending',
                        response: null,
                        conversation: []
                    };

                    await db.collection('requests').add(newRequest);

                    formData = { 
                        carPart: '', carManufacturer: '', carModel: '', year: '', 
                        description: '', name: '', phone: '', email: '', urgency: '×¨×’×™×œ'
                    };
                    showSuccess = true;
                    isSubmitting = false;
                    render();

                    setTimeout(() => {
                        showSuccess = false;
                        render();
                    }, 5000);
                } catch (error) {
                    console.error('Error submitting request:', error);
                    alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×‘×§×©×”. × ×¡×” ×©×•×‘.');
                    isSubmitting = false;
                    render();
                }
            }

            function toggleStatusCheck() {
                showStatusCheck = !showStatusCheck;
                render();
            }

            async function checkStatus() {
                if (!statusPhone.trim()) {
                    alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ××• ×©×');
                    statusResult = null;
                    return;
                }

                try {
                    // Load all requests from Firebase
                    const querySnapshot = await db.collection('requests').get();
                    const allRequests = [];
                    
                    querySnapshot.forEach((doc) => {
                        allRequests.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    // ×—×™×¤×•×© ×œ×¤×™ ×˜×œ×¤×•×Ÿ ××• ×©×
                    const searchTerm = statusPhone.trim();
                    statusResult = allRequests.find(r => 
                        (r.phone && r.phone.replace(/\D/g, '').includes(searchTerm.replace(/\D/g, ''))) || 
                        (r.name && r.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    );
                    
                    if (!statusResult) {
                        alert('×œ× × ××¦××” ×‘×§×©×” ×¢× ×”××™×“×¢ ×”×–×”');
                    }
                    render();
                } catch (error) {
                    console.error('Error checking status:', error);
                    alert('×©×’×™××” ×‘×—×™×¤×•×©: ' + error.message);
                }
            }

            async function deleteRequest(id) {
                if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×‘×§×©×” ×–×•?')) {
                    return;
                }

                try {
                    await db.collection('requests').doc(id).delete();
                    
                    // ×”×¡×¨ ××”××¢×¨×š ×”××§×•××™
                    requests = requests.filter(r => r.id !== id);
                    
                    // ×‘×˜×œ ××ª selectedRequest ×•×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×”
                    selectedRequest = null;
                    responseText = '';
                    
                    alert('×”×‘×§×©×” × ××—×§×” ×‘×”×¦×œ×—×” âœ“');
                    render();
                } catch (error) {
                    console.error('Error deleting request:', error);
                    alert('×©×’×™××” ×‘××—×™×§×ª ×”×‘×§×©×”: ' + error.message);
                }
            }

            async function viewRequest(id) {
                // Try to find in local requests first
                selectedRequest = requests.find(r => r.id === id);
                
                // If not found locally, load from Firebase
                if (!selectedRequest) {
                    try {
                        const doc = await db.collection('requests').doc(id).get();
                        if (doc.exists) {
                            selectedRequest = { id: doc.id, ...doc.data() };
                        } else {
                            alert('×‘×§×©×” ×œ× × ××¦××”');
                            return;
                        }
                    } catch (error) {
                        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×‘×§×©×”');
                        return;
                    }
                }
                
                // Mark all messages as read (only if admin)
                if (currentView === 'admin' && selectedRequest && selectedRequest.conversation) {
                    selectedRequest.conversation = selectedRequest.conversation.map(msg => ({
                        ...msg,
                        read: true
                    }));
                    
                    // Update in Firebase
                    db.collection('requests').doc(id).update({
                        conversation: selectedRequest.conversation
                    }).catch(err => console.error('Error updating:', err));
                }
                
                responseText = '';
                render();
            }

            function backToList() {
                selectedRequest = null;
                responseText = '';
                render();
            }

            async function sendResponse() {
                const textarea = document.getElementById('responseText');
                const message = textarea ? textarea.value.trim() : '';
                
                if (!message) {
                    alert('× × ×œ×›×ª×•×‘ ×”×•×“×¢×”');
                    return;
                }

                try {
                    if (!selectedRequest || !selectedRequest.id) {
                        alert('×©×’×™××”: ×œ× × ×‘×—×¨×” ×‘×§×©×”');
                        return;
                    }

                    const sender = currentView === 'admin' ? 'ofer' : 'customer';
                    const conversation = selectedRequest.conversation || [];
                    
                    // Add message to conversation
                    conversation.push({
                        sender: sender,
                        message: message,
                        timestamp: new Date().toISOString(),
                        read: sender === 'ofer' // Mark admin messages as read automatically
                    });

                    // Prepare update object
                    const updateObj = {
                        conversation: conversation
                    };

                    // If ofer's first response - mark as answered
                    if (sender === 'ofer' && !selectedRequest.response) {
                        updateObj.response = message;
                        updateObj.status = 'answered';
                        updateObj.answeredAt = new Date().toISOString();
                    }
                    
                    // If customer sends a new message after answered - change back to pending
                    if (sender === 'customer' && selectedRequest.status === 'answered') {
                        updateObj.status = 'pending';
                    }

                    // Update Firebase
                    await db.collection('requests').doc(selectedRequest.id).update(updateObj);

                    // Clear input
                    if (textarea) textarea.value = '';
                    
                    // Reload the request to show updated data
                    const updatedRequest = await db.collection('requests').doc(selectedRequest.id).get();
                    selectedRequest = { id: updatedRequest.id, ...updatedRequest.data() };
                    render();
                    
                    // Auto-scroll to bottom
                    setTimeout(() => {
                        const chatContainer = document.querySelector('[class*="overflow-y-auto"]');
                        if (chatContainer) {
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”: ' + error.message);
                }
            }

            // Carousel functionality
            let currentCarouselIndex = 0;
            const totalCarouselItems = 5;

            function carouselGoTo(index) {
                currentCarouselIndex = index;
                updateCarousel();
            }

            function carouselNext() {
                currentCarouselIndex = (currentCarouselIndex + 1) % totalCarouselItems;
                updateCarousel();
            }

            function carouselPrev() {
                currentCarouselIndex = (currentCarouselIndex - 1 + totalCarouselItems) % totalCarouselItems;
                updateCarousel();
            }

            function updateCarousel() {
                const carouselInner = document.getElementById('carouselInner');
                if (carouselInner) {
                    const offset = -currentCarouselIndex * 100;
                    carouselInner.style.transform = `translateX(${offset}%)`;
                }
                
                // Update dots
                const dots = document.querySelectorAll('.carousel-dot');
                dots.forEach((dot, idx) => {
                    if (idx === currentCarouselIndex) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }

            // Make functions global
            window.carouselNext = carouselNext;
            window.carouselPrev = carouselPrev;
            window.carouselGoTo = carouselGoTo;

            // Make functions global
            window.toggleStatusCheck = toggleStatusCheck;
            window.checkStatus = checkStatus;
            window.viewRequest = viewRequest;
            window.backToList = backToList;
            window.sendResponse = sendResponse;
            window.deleteRequest = deleteRequest;
            async function submitRating(stars) {
                const reviewText = document.getElementById('reviewText');
                const review = reviewText ? reviewText.value.trim() : '';

                try {
                    if (!selectedRequest || !selectedRequest.id) {
                        alert('×©×’×™××”: ×œ× × ×‘×—×¨×” ×‘×§×©×”');
                        return;
                    }

                    await db.collection('requests').doc(selectedRequest.id).update({
                        rating: stars,
                        review: review,
                        ratedAt: new Date().toISOString()
                    });

                    // Update local request
                    selectedRequest.rating = stars;
                    selectedRequest.review = review;
                    
                    // Also update in requests array
                    const idx = requests.findIndex(r => r.id === selectedRequest.id);
                    if (idx !== -1) {
                        requests[idx].rating = stars;
                        requests[idx].review = review;
                    }
                    
                    render();
                } catch (error) {
                    console.error('Error submitting rating:', error);
                    alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×“×™×¨×•×’: ' + error.message);
                }
            }

            async function submitAdminRating(stars) {
                const reviewText = document.getElementById('adminReviewText');
                const review = reviewText ? reviewText.value.trim() : '';

                try {
                    if (!selectedRequest || !selectedRequest.id) {
                        alert('×©×’×™××”: ×œ× × ×‘×—×¨×” ×‘×§×©×”');
                        return;
                    }

                    await db.collection('requests').doc(selectedRequest.id).update({
                        rating: stars,
                        review: review,
                        ratedAt: new Date().toISOString()
                    });

                    // Update local request
                    selectedRequest.rating = stars;
                    selectedRequest.review = review;
                    
                    // Also update in requests array
                    const idx = requests.findIndex(r => r.id === selectedRequest.id);
                    if (idx !== -1) {
                        requests[idx].rating = stars;
                        requests[idx].review = review;
                    }
                    
                    alert('×”×“×™×¨×•×’ × ×©××¨ ×‘×”×¦×œ×—×”! â­');
                    render();
                } catch (error) {
                    console.error('Error submitting rating:', error);
                    alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×“×™×¨×•×’: ' + error.message);
                }
            }

            function showEditRating() {
                const newRating = prompt('×”×–×Ÿ ×“×™×¨×•×’ ×—×“×© (1-5):', selectedRequest.rating);
                if (newRating) {
                    const rating = parseInt(newRating);
                    if (rating >= 1 && rating <= 5) {
                        submitAdminRating(rating);
                    } else {
                        alert('×”×“×™×¨×•×’ ×—×™×™×‘ ×œ×”×™×•×ª ×‘×™×Ÿ 1 ×œ-5');
                    }
                }
            }

            window.submitAdminRating = submitAdminRating;
            window.showEditRating = showEditRating;
        }
    </script>
</body>
</html>
